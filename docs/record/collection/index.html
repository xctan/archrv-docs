<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-record/collection">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Arch Linux RISC-V Packaging Guide RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Arch Linux RISC-V Packaging Guide Atom Feed"><title data-rh="true">奇奇怪怪的错误们 | Arch Linux RISC-V Packaging Guide</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://riscv-notes.sh1mar.in/docs/record/collection"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="奇奇怪怪的错误们 | Arch Linux RISC-V Packaging Guide"><meta data-rh="true" name="description" content="阿里云上遇到 sigsegv"><meta data-rh="true" property="og:description" content="阿里云上遇到 sigsegv"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://riscv-notes.sh1mar.in/docs/record/collection"><link data-rh="true" rel="alternate" href="https://riscv-notes.sh1mar.in/docs/record/collection" hreflang="en"><link data-rh="true" rel="alternate" href="https://riscv-notes.sh1mar.in/docs/record/collection" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.48cc2458.css">
<link rel="preload" href="/assets/js/runtime~main.1e457bc7.js" as="script">
<link rel="preload" href="/assets/js/main.42ec8c8f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ArchRV-Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="ArchRV-Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ArchRV-Manual</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documents</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/felixonmars/archriscv-packages" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/guide/start-guide">Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/record/collection">Record</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/record/collection">奇奇怪怪的错误们</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/record/lto">lto 相关的问题</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/record/resources">一些参考资料</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/record/rust-related">Rust 相关的一些记录</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/record/unstable">随时会过时的记录</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Record</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">奇奇怪怪的错误们</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>奇奇怪怪的错误们</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="阿里云上遇到-sigsegv">阿里云上遇到 sigsegv<a class="hash-link" href="#阿里云上遇到-sigsegv" title="Direct link to heading">​</a></h2><p>如果在阿里云上遇到奇奇怪怪的 <code>segmentation fault</code>，
首先确认 rustc 的<a href="/docs/record/rust-related#%E7%BC%96%E8%AF%91%E6%97%B6%E9%81%87%E5%88%B0%E4%BA%86%E5%A5%87%E6%80%AA%E7%9A%84-sigsegv">优化</a>
有无问题，如果查不出来问题的话，
默认认为阿里云的虚拟化有问题。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="executable-wasm-ld-doesnt-exist-stuck">Executable &quot;wasm-ld&quot; doesn&#x27;t exist! (STUCK)<a class="hash-link" href="#executable-wasm-ld-doesnt-exist-stuck" title="Direct link to heading">​</a></h2><p>要安装 lld，wasm-ld 只在 lld 里面有。</p><hr><p>Firefox 的话，引入 lld 会带来另外的问题。lld 是需要默认关闭的，
问题来源于 <code>-mno-relax</code> 和 <code>-mrelax</code> 。</p><p>可以查看这个 PR 了解详情 <a href="https://github.com/felixonmars/archriscv-packages/pull/139" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/139</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pthread-related-issue">pthread related issue<a class="hash-link" href="#pthread-related-issue" title="Direct link to heading">​</a></h2><p>标准答案： <a href="https://github.com/felixonmars/archriscv-packages/pull/1035" target="_blank" rel="noopener noreferrer">PR #1035</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gcc-atomic">gcc atomic<a class="hash-link" href="#gcc-atomic" title="Direct link to heading">​</a></h2><p>gcc 的 1B 2B atomic 实现在 riscv64 有问题。gcc 的 1B 2B atomic 实现需要跑到 libatomic，
于是没法在编译期判断是否无锁</p><blockquote><p>ref: <a href="https://code.videolan.org/videolan/vlc/-/issues/20683" target="_blank" rel="noopener noreferrer">https://code.videolan.org/videolan/vlc/-/issues/20683</a></p><p>The GCC docs make it clear that -pthread is the correct way to use the pthread
library on POSIX systems.  Not only does it add extra necessary linker options
for some targets, but it also adds some extra necessary preprocessor options
for many targets.  There is also the issue that the library is called -lpthread
on some systems, and -lpthreads on others.  The -pthread option handles this
correctly.</p><p><strong>It is a known problem that the RISC-V gcc atomic support needs more work.
RISC-V only supports 4 and 8 byte atomic operations in hardware.  1 and 2 byte
operations are implemented using instruction sequences with locks, and this is
currently done via a call into libatomic.</strong>  However, mixing lock free and
non-locking atomic sequences can potentially cause run-time failures.  We need
to instead emit instruction sequences using 4 and/or 8 byte atomic instructions
without locks.  This is on the list of things that need to be fixed, but there
are a lot of things that need to be fixed and we haven&#x27;t gotten around to
fixing this one yet.  This definitively needs to be fixed before gcc 9, and
hopefully much sooner than that.</p><p>While the RISC-V gcc port does need to be fixed, it is still true that you
should be using -pthread instead of -lpthread.</p></blockquote><p>除此之外还有一个很诡异的事情：就是在 gcc 里，<code>std::atomic&lt;bool&gt;::is_always_lock_free</code>
是 false，<code>std::atomic&lt;int&gt;::is_always_lock_free</code> 是 true。但是如果你在运行的时候
整一个 bool b; <code>std::atomic_is_lock_free(&amp;b)</code>，你会发现它是 true，而且是，不管怎么试，
在哪试，它都是 true。</p><p>在 gcc 里面大概 ATOMIC_BOOL_LOCK_FREE 是 1（1 for the built-in atomic types
that are sometimes lock-free)</p><blockquote><p>ref: <a href="https://www.mail-archive.com/gcc-bugs@gcc.gnu.org/msg664254.html" target="_blank" rel="noopener noreferrer">https://www.mail-archive.com/gcc-bugs@gcc.gnu.org/msg664254.html</a></p><p>tldr: 只能等 gcc 的人实现 sub-word lock-free atomic 了</p><p>All atomic types except for std::atomic_flag may be implemented using mutexes
or other locking operations, rather than using the lock-free atomic CPU
instructions. Atomic types are also allowed to be sometimes lock-free, e.g. if
only aligned memory accesses are naturally atomic on a given architecture,
misaligned objects of the same type have to use locks.</p><p>Thanks for the detailed writeup!</p><p>Your analysis is basically correct, but I would add that ICC&#x27;s behavior here is
unsound (it only appears to &quot;implement[] this behavior correctly&quot; in simple cases)
whereas the GCC/Clang behavior is sound but surprising. For GCC, ICC, and Clang, <code>identity &lt;fp&gt;</code>
and <code>identity&lt;float&gt;</code> are the same type. Therefore it&#x27;s not possible for <code>identity &lt;fp&gt;::type</code>
and <code>identity&lt;float&gt;::type</code> to have different alignments, because they&#x27;re
the same type. So, for an example such as this:</p></blockquote><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> fp  </span><span class="token function" style="color:#d73a49">__attribute__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">aligned</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">alignof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">identity</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">fp</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">alignof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typename</span><span class="token plain"> </span><span class="token class-name">identity</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">float</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>under GCC and Clang, both lines print out 4, whereas under ICC, they either both
print out 4 or both print out 16 depending on which one happens to appear first
in the program (and in general you can encounter ODR violations when using ICC despite
there being nothing wrong at the source level).</p></blockquote><blockquote><p>Fundamentally, the &#x27;aligned&#x27; attribute is a GCC extension, so the GCC folks get
to define how it works. And they chose that instead of it resulting in a different
type that&#x27;s <em>almost</em> like the original type (for example, treating it as a type
qualifier), it results in the same type, but that in some contexts that same type
behaves differently. That&#x27;s a semantic disaster, but it&#x27;s what we live with. And
in particular, the only way for template instantiation to be sound in the presence
of this semantic disaster is for it to ignore all such attributes on template type
arguments.</p></blockquote><ul><li><p>一些参考解决方案：</p><ul><li><a href="https://github.com/savoirfairelinux/opendht/pull/598/files" target="_blank" rel="noopener noreferrer">https://github.com/savoirfairelinux/opendht/pull/598/files</a></li><li>如何检查 libatomic: <a href="https://github.com/danvratil/qcoro/pull/52/commits/312f2fca861b4c623481da58241a1139e013ef83" target="_blank" rel="noopener noreferrer">https://github.com/danvratil/qcoro/pull/52/commits/312f2fca861b4c623481da58241a1139e013ef83</a></li></ul></li><li><p>给上游看的解释范例：</p><ul><li><a href="https://github.com/savoirfairelinux/opendht/pull/598#issuecomment-1086945416" target="_blank" rel="noopener noreferrer">https://github.com/savoirfairelinux/opendht/pull/598#issuecomment-1086945416</a></li><li><a href="https://github.com/telegramdesktop/tdesktop/pull/24275" target="_blank" rel="noopener noreferrer">https://github.com/telegramdesktop/tdesktop/pull/24275</a></li><li>证明建立&quot;你显式用了atomic&quot;和&quot;你得检查libatomic&quot;直接关系的参考文档:
<a href="https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_concurrency.html" target="_blank" rel="noopener noreferrer">https://gcc.gnu.org/onlinedocs/libstdc++/manual/using_concurrency.html</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-fno-common">-fno-common<a class="hash-link" href="#-fno-common" title="Direct link to heading">​</a></h2><p><strong>Q</strong>: -fno-common 取代了 -fcommon, 这种情况优先 -fno-common 还是 patch source？</p><p><strong>A</strong>: 优先 patch source。
一般来说能不动flags尽量不动。
少数例外是，比如，这个项目死了十年了，连个repo都找不到。</p><p>不过如果是 -fcommon 这种，比较推荐的是先提给上游，咱们patch着打。
这样下次上游发版本arch那边更新的时候，就会莫名其妙好了，他们不用做什么，我们也只用删掉patch。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-wno-format">-Wno-format<a class="hash-link" href="#-wno-format" title="Direct link to heading">​</a></h2><p>如果遇到
<code>cc1: error: -Wformat-security ignored without -Wformat [-Werror=format-security]</code>，
这个错误是因为代码被编译的时候，<code>CFLAG</code> 选项多了一个 <code>-Wno-format</code>，这个选项会关闭
<code>-Wformat</code>，但 <code>-Werror=format-security</code> 仍然保留着。</p><p>解决方案首先是让上游修，然后引用 patch，参考上面那一章节。</p><p>如果是一万年不更新的代码仓库，那可以酌情使用
<code>${CFLAG#-Werror=format-security}</code> 或者 <code>sed -i &#x27;s/ -Werror=format-security // Makefile</code>
把这个选项删除。</p><p>但是尽量现在群里讨论，问问前辈的意见。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="-werrorformat-security">-Werror=format-security<a class="hash-link" href="#-werrorformat-security" title="Direct link to heading">​</a></h2><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">manpage</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-Wformat-security</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   If -Wformat is specified, also warn about uses of format functions that represent possible security problems.  At present, this warns about calls to &quot;printf&quot; and &quot;scanf&quot; functions where the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   format string is not a string literal and there are no format arguments, as in &quot;printf (foo);&quot;.  This may be a security hole if the format string came from untrusted input and contains %n.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (This is currently a subset of what -Wformat-nonliteral warns about, but in future warnings may be added to -Wformat-security that are not included in -Wformat-nonliteral.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>首先，优先给上游发补丁。从 manpage 也可以看的出来，只需要把 <code>printf</code> 改成 <code>printf(&quot;%s&quot;)</code> 的形式即可。</p><p>除非上游十多年没动静，才可以选择把这个选项删掉。
可以用： <code>CFLAGS=${CFLAGS/-Werror=format-security/}</code></p><p>如果上游很难沟通，或者上游代码不太好修，优先自己修，然后和群里的前辈商量一下解决方案。</p><blockquote><p>Reference:
<a href="https://github.com/felixonmars/archriscv-packages/pull/559" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/559</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何快捷生成-sha256sums">如何快捷生成 sha256sums<a class="hash-link" href="#如何快捷生成-sha256sums" title="Direct link to heading">​</a></h2><p>用 <a href="https://archlinux.org/packages/community/x86_64/pacman-contrib/" target="_blank" rel="noopener noreferrer">updpkgsums</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="修代码优先还是改编译-flag-优先">修代码优先还是改编译 flag 优先？<a class="hash-link" href="#修代码优先还是改编译-flag-优先" title="Direct link to heading">​</a></h2><p>优先修代码。</p><blockquote><p>参考：
<a href="https://build.opensuse.org/package/view_file/devel:ARM:Factory:Contrib:ILP32/presage/presage-0.9.1-gcc11.patch?expand=0" target="_blank" rel="noopener noreferrer">https://build.opensuse.org/package/view_file/devel:ARM:Factory:Contrib:ILP32/presage/presage-0.9.1-gcc11.patch?expand=0</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="noqemu">noqemu<a class="hash-link" href="#noqemu" title="Direct link to heading">​</a></h2><p>能 patch 使用 generic 分支的就不要 noqemu，如果 qemu 过不了板子能过，不要修。</p><ul><li>为什么我们不尝试对 qemu user 进行修复呢？</li></ul><p>现在我们遇到好几个 qemu 挂死的版本，我们维护了好几个版本</p><ol><li>首先是这个 always-malloc，我们手打了个 glib，
稍微缓解了一些 <a href="https://github.com/ZenithalHourlyRate/glib" target="_blank" rel="noopener noreferrer">https://github.com/ZenithalHourlyRate/glib</a></li><li>然后 qemu 在 futex pi 这个 syscall 上翻译不行，
这在某些 glibc 版本下会导致 pthread 挂（影响所有 qemu-user 版本，不只 riscv），
然后粗糙搓了一个 <a href="https://github.com/ZenithalHourlyRate/qemu" target="_blank" rel="noopener noreferrer">https://github.com/ZenithalHourlyRate/qemu</a></li><li>我们还发现一些情况下进程会 Z 掉（打 rust 的时候），我们猜测和这个
issue 有关 <a href="https://gitlab.com/qemu-project/qemu/-/issues/140" target="_blank" rel="noopener noreferrer">https://gitlab.com/qemu-project/qemu/-/issues/140</a> ，
但看起来非常 non-trivial 不好修，称其为 vfork 吧</li><li>在 always-malloc 修了以后，我们依然会遇到和 1 一样的 futex hang
的问题（打 go 的时候），我们还没调查咋回事</li></ol><ul><li>为什么要选择手动维护 noqemu blacklist 这种看似低效的方式呢？</li></ul><p>根据测试，QEMU-User 编译速度大于 RISC-V 板子大于 QEMU-System，
手工维护 noqemu blacklist 其实效率反而更高一些。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="rust">Rust<a class="hash-link" href="#rust" title="Direct link to heading">​</a></h2><p>参考 <a href="/docs/record/rust-related"><em>Rust 相关的一些记录</em></a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="sse-related-issue">SSE Related issue<a class="hash-link" href="#sse-related-issue" title="Direct link to heading">​</a></h2><p><del>放到 riscv 板子上跑，然后标 noqemu</del></p><p>现在可以用 simde2 来模拟 SSE2 实现，以提供 SSE2 支持，具体可以参考这个 PR： <a href="https://github.com/felixonmars/archriscv-packages/pull/3011/files" target="_blank" rel="noopener noreferrer">#3011</a>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="go">Go<a class="hash-link" href="#go" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="patch-go-dep">Patch <code>go dep</code><a class="hash-link" href="#patch-go-dep" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">console</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go mod edit -replace github.com/prometheus/client_golang</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">github.com/prometheus/client_golang@efe7aa7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go mod download github.com/prometheus/client_golang</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 这个是根据不加 go get 的报错提示来添加的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 没报错可以不用加，注意要去掉版本号（@ 后面的部分）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go get github.com/prometheus/client_golang/prometheus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go generate  </span><span class="token comment" style="color:#999988;font-style:italic"># if necessary</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> cmd/traefik</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">go build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>具体参考：
<a href="https://github.com/felixonmars/archriscv-packages/pull/346/files" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/346/files</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="给-go-包的依赖的依赖打patch的正确方式">给 go 包的依赖（的依赖）打patch的正确方式<a class="hash-link" href="#给-go-包的依赖的依赖打patch的正确方式" title="Direct link to heading">​</a></h3><p>Go 比较特殊，Go 是在 build 的时候 install。
假设有一系列的依赖链：<code>a-&gt;b-&gt;c-&gt;d-&gt;e</code>。
如果需要修 d，则 bcd 都需要 fork，修好 d 之后 bc 改依赖。</p><p>Go 还可以在 go.mod 里用 replace 语法来替换依赖：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">go.mod</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">replace github.com/creack/goselect =&gt; github.com/creack/goselect v0.1.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>具体参考：
<a href="https://github.com/felixonmars/archriscv-packages/pull/387/commits/ad0e66c31b21efd93fff93be8cce5b9e13b59953" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/387/commits/ad0e66c31b21efd93fff93be8cce5b9e13b59953</a></p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="编译-golang-包的时候经常卡死">编译 golang 包的时候经常卡死<a class="hash-link" href="#编译-golang-包的时候经常卡死" title="Direct link to heading">​</a></h3><p>QEMU 的锅，直接杀掉重新开始。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="bad-pointer">bad pointer<a class="hash-link" href="#bad-pointer" title="Direct link to heading">​</a></h3><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">runtime: bad pointer in frame ... at 0x...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fatal error: invalid pointer found on stack</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以跟踪一下这个 issue: <a href="https://github.com/golang/go/issues/51101" target="_blank" rel="noopener noreferrer">https://github.com/golang/go/issues/51101</a></p><p>以后 go build 的时候加上这个 flag <code>-gcflags=all=&quot;-N -l&quot;</code>，并且往上面那个 issue 报一下。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="版本号">版本号<a class="hash-link" href="#版本号" title="Direct link to heading">​</a></h2><p>版本号不要超过主线，尽量以催更为主。
如果实在不行就加一行注释，提一下上游的进度，让以后维护的人有个参考。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="循环依赖">循环依赖<a class="hash-link" href="#循环依赖" title="Direct link to heading">​</a></h2><p>有些包可以一起打，但在状态页上显示互相缺了对方，这种需要 bootstrap。</p><blockquote><p>详细参考 ghc bootstrap Patch:
<a href="https://github.com/felixonmars/archriscv-packages/pull/17/commits/36279fff5314fbcd212549ede73db5257ef10b1d" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/pull/17/commits/36279fff5314fbcd212549ede73db5257ef10b1d</a></p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="intel-related">Intel related<a class="hash-link" href="#intel-related" title="Direct link to heading">​</a></h2><p>Intel 的一些包，没留 Generic 实现，只有 x86 simd 的，比如 hyperscan，
这种包就直接跳过不管了。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="qmake">Qmake<a class="hash-link" href="#qmake" title="Direct link to heading">​</a></h2><p>使用 qmake 构建的包构建时提示 <code>Could not find qmake spec &#x27;default&#x27;.</code></p><p>这种情况目前需要去板子上打包。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="xx-is-not-available-for-the-riscv64-architecture">XX is not available for the &#x27;riscv64&#x27; architecture<a class="hash-link" href="#xx-is-not-available-for-the-riscv64-architecture" title="Direct link to heading">​</a></h2><p>这是因为 PKGBUILD 的 arch 数组设置 riscv64 的值。
请不要把 arch 改为 any，any 表示不同架构出的包二进制上没有区别。</p><p>你可以用 setconf 重新设置值：</p><div class="language-console codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockTitle_Ktv7">console</div><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-console codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">setconf PKGBUILD arch &#x27;(riscv64 x86_64)&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>还有请注意
<a href="/docs/guide/PR-guide#%E4%B8%8D%E8%A6%81%E6%8F%90%E4%BA%A4-archany">不要提交修改后的 arch</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="msse">msse<a class="hash-link" href="#msse" title="Direct link to heading">​</a></h2><p>Error: <code>c++: error: unrecognized command-line option &#x27;-msse&#x27;</code></p><p>这是因为 -msse 这个编译选项暂时还不支持 <code>x86_64</code> 以外的 Arch，
你需要查看一下这个项目的 CMakeList 选项，暂时把他关闭。</p><p>比如 <code>cmake -DSSE=OFF</code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unknown-public-key">Unknown public key....<a class="hash-link" href="#unknown-public-key" title="Direct link to heading">​</a></h2><p>这是因为本地的 gpg 数据库没有这个开发者的公钥。你可以用命令
<code>gpg --recv-key keyid</code> 下载并导入这个 key。</p><hr><p>如果遇到了 <code>gpg: keyserver receive failed: No data</code> 这样的错误，
大概率是 keyserver 被橄榄了。</p><blockquote><p>sks pool 因为是单增的，无法满足 GDPR 对被遗忘权的规定，
被欧盟法律橄榄了。</p></blockquote><p>你可以先尝试在下面几个 sks 镜像看看能不能找到：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">https://pgp.surfnet.nl/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgp.uni-mainz.de 11370</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pgp.circl.lu 11370</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">keys.andreas-puls.de 11370</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 <code>gpg --keyserver https://example.com --recv-key keyid</code> 来指定下载服务器。</p><p>如果还是找不到，可以找找他们项目主页，团队介绍，个人博客等等等页面。</p><p>如果是 GitHub 的项目，你可以找到那个开发者的主页，然后在后面加上 <code>.gpg</code> 来查看他的 key。</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">https://github.com/user.gpg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       ^^^^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后用 gpg import 导入： <code>curl https://github.com/user.gpg | gpg --import</code></p><p>Arch Linux 最近通过了把 key 放到 SVN 的 RFC，等 Arch 也有 key 了我们就可以删掉了。
如果找不到 key 就到上游开 bug report 让他们把 key 放到 svn。
如果你找到了 key，可以先把 key 和 riscv64.patch 放一起提交到肥猫仓库。</p><hr><p>如果实在是找不到 key，但是又急着测试，可以用参数 <code>--skippgpcheck</code> 暂时跳过检查。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">extra-riscv64-build -- -d </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token plain"> -- --skippgpcheck</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                 </span><span class="token comment" style="color:#999988;font-style:italic"># ^^^^^^^^^^^^^^^^^ 多用一个 -- 把 skippgpcheck 传给更下层的 makepkg</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>或者可以参考这个：
<a href="https://github.com/archlinuxcn/lilac/blob/master/recv_gpg_keys" target="_blank" rel="noopener noreferrer">https://github.com/archlinuxcn/lilac/blob/master/recv_gpg_keys</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="electron">Electron<a class="hash-link" href="#electron" title="Direct link to heading">​</a></h2><p>v8 版本低于 9.0 的就不用修了，从 9.0 开始有实验性的 risc-v 支持。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="node-sass">node-sass<a class="hash-link" href="#node-sass" title="Direct link to heading">​</a></h2><p>node-sass v6 就是不支持 node v17 的，node-sass 对 njs v17 的支持始于版本 7.0.0，
6.x 支持的 njs version：12, 14, 15, 16，所以要么就把 dependency 从 nodejs 改成 nodejs-lts-gallium，
要么就催上游更新 package.json 里 node-sass 的版本，which is nonsense，因为大版本号的更新往往带来不兼容。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="关于-upstream">关于 upstream<a class="hash-link" href="#关于-upstream" title="Direct link to heading">​</a></h2><p>如果上游的 maintainer 是肥猫的话，可以直接在群里 @ 肥猫。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="python-2to3">Python 2to3<a class="hash-link" href="#python-2to3" title="Direct link to heading">​</a></h2><p>Python 的包不管 major version 都要跑一次 2to3。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="测试">测试<a class="hash-link" href="#测试" title="Direct link to heading">​</a></h2><p>如果有的包不在乎测试是否通过，比如 <code>test || echo</code>，那就直接把测试注释掉。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="访问一些会在编译期被删除的文件">访问一些会在编译期被删除的文件<a class="hash-link" href="#访问一些会在编译期被删除的文件" title="Direct link to heading">​</a></h2><p>有一个比较脏的做法：往 PKGBUILD 里塞一个 bash，然后就用这个 subshell 来交互。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gcc-nostdlib">gcc nostdlib<a class="hash-link" href="#gcc-nostdlib" title="Direct link to heading">​</a></h2><p><code>-nostdlib</code> 会覆盖 <code>-pthread</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="glibc-optimization">glibc optimization<a class="hash-link" href="#glibc-optimization" title="Direct link to heading">​</a></h2><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">error: glibc cannot be compiled without optimization</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>solution: 加上 <code>-O1</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="patch-hunk-offset">patch hunk offset<a class="hash-link" href="#patch-hunk-offset" title="Direct link to heading">​</a></h2><p><strong>Q:</strong> 平时更新 patch 的时候，如果有代码的 patch hunk 飘了，能打上但是有 offset，需要
把 patch 更新成最新的行号吗？</p><p><strong>A:</strong> 不需要</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unguarded-availability-new">unguarded-availability-new<a class="hash-link" href="#unguarded-availability-new" title="Direct link to heading">​</a></h2><p>Error:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cc1plus: error: ‘-Werror=unguarded-availability-new’: no option ‘-Wunguarded-availability-new’</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这个选项只有 clang 才有，如果没有强制使用 GNU 的构建工具，
可以设置环境变量 <code>CC=clang CXX=clang++</code> 强制使用 clang 来编译。</p><p>如果这个项目用的 cmake，可以加两个参数：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;-DCMAKE_C_COMPILER=clang&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;-DCMAKE_CXX_COMPILER=clang++&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同时记得给上游报 BUG 让他们默认使用 clang 来编译。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tarball-url-变了该怎么办">tarball URL 变了该怎么办<a class="hash-link" href="#tarball-url-变了该怎么办" title="Direct link to heading">​</a></h2><p>给 Arch 交 BUG</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="在-qemu-内构建失败但在板子上构建成功怎么处理">在 QEMU 内构建失败但在板子上构建成功怎么处理<a class="hash-link" href="#在-qemu-内构建失败但在板子上构建成功怎么处理" title="Direct link to heading">​</a></h2><p>标记这个包为 noqemu，同时往 repo 里的 qemu-user-blacklist.txt 里加入这个包。</p><p>Ref: <a href="https://github.com/felixonmars/archriscv-packages/blob/master/qemu-user-blacklist.txt" target="_blank" rel="noopener noreferrer">https://github.com/felixonmars/archriscv-packages/blob/master/qemu-user-blacklist.txt</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="invalid-or-corrupted-package-pgp-signature">invalid or corrupted package (pgp signature)<a class="hash-link" href="#invalid-or-corrupted-package-pgp-signature" title="Direct link to heading">​</a></h2><p>如果在构建 any 包的时候遇到这个问题，可能是因为缓存冲突问题。
x86_64 和 riscv64 下的 any 包的名字是一样的，但是这两个的签名不同。
如果有人构建包的时候没建缓存目录，完事儿了也没删掉，
当构建的时候用到了别人的缓存就会出现这个问题。</p><p>解决方案：</p><ul><li>自建 cache 目录</li><li>删了缓存重新跑构建</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="磁盘占用满了">磁盘占用满了<a class="hash-link" href="#磁盘占用满了" title="Direct link to heading">​</a></h2><p><code>lto: fatal error: write: No space left on device</code></p><p>很有可能不是真的吃满了，是因为 devtools 使用了 systemd-nspawn，而后者默认用参数 <code>size=10%</code>
挂载在 <code>/tmp</code> 目录上。</p><p>可以尝试调整 <code>SYSTEMD_NSPAWN_TMPFS_TMP</code> 这个变量的值来拒绝挂载 tmpfs</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token assign-left variable" style="color:#36acaa">SYSTEMD_NSPAWN_TMPFS_TMP</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> extra-x86_64-build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>记得需要加上 sudo 用 root 跑，不然 devtools 自己 sudo 了之后，这个环境变量就没了。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="大量依赖缺失">大量依赖缺失<a class="hash-link" href="#大量依赖缺失" title="Direct link to heading">​</a></h2><p>不一定是所有依赖都不匹配，pacman 是 <code>depends=(a, b, c, d, e)</code>，
然后如果 e 缺了它会说 <code>a b c d e not found</code>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configguess">config.guess<a class="hash-link" href="#configguess" title="Direct link to heading">​</a></h2><p>如果遇到</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">config.guess fail to detect system type</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 <code>autoreconf -fi</code> 更新附带文件，同时向上游报告它们的文件需要更新。
如果因为版本过老使用命令失败的，拷贝
<code>/usr/share/autoconf/build-aux/config.guess</code> 和 <code>config.sub</code> 文件，并向上游报告</p><blockquote><p><strong>请一定要向上游报告！</strong></p><p>config.sub 上游有职责及时更新。</p></blockquote><h2 class="anchor anchorWithStickyNavbar_LWe7" id="nodejs-的某些包出现怪异的错误">nodejs 的某些包出现怪异的错误<a class="hash-link" href="#nodejs-的某些包出现怪异的错误" title="Direct link to heading">​</a></h2><p>比如, babel 打印一行不明所以的报错然后退出.</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{ valid: true, value: null }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这是因为目前 riscv64 上的 V8 的 JIT 有 Bug.</p><p>可以尝试下面两种方法</p><ul><li>设置环境变量 <code>NODE_OPTIONS=&#x27;--jitless&#x27;</code> 或者给 node 传 <code>--jitless</code>. 但是这会一并禁用 WebAssembly. 好处是用环境变量传递不用 patch 代码</li><li>给 Node 加上 <code>--max-opt=0</code> 参数. 这实际上是一个 V8 的参数. 这个参数不能通过环境变量传递, 需要 patch 代码, 但是不会禁用 WebAssembly.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/Avimitin/archrv-docs/docs/record/collection.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/guide/bug-report"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">如何给 Arch 报 BUG</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/record/lto"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">lto 相关的问题</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#阿里云上遇到-sigsegv" class="table-of-contents__link toc-highlight">阿里云上遇到 sigsegv</a></li><li><a href="#executable-wasm-ld-doesnt-exist-stuck" class="table-of-contents__link toc-highlight">Executable &quot;wasm-ld&quot; doesn&#39;t exist! (STUCK)</a></li><li><a href="#pthread-related-issue" class="table-of-contents__link toc-highlight">pthread related issue</a></li><li><a href="#gcc-atomic" class="table-of-contents__link toc-highlight">gcc atomic</a></li><li><a href="#-fno-common" class="table-of-contents__link toc-highlight">-fno-common</a></li><li><a href="#-wno-format" class="table-of-contents__link toc-highlight">-Wno-format</a></li><li><a href="#-werrorformat-security" class="table-of-contents__link toc-highlight">-Werror=format-security</a></li><li><a href="#如何快捷生成-sha256sums" class="table-of-contents__link toc-highlight">如何快捷生成 sha256sums</a></li><li><a href="#修代码优先还是改编译-flag-优先" class="table-of-contents__link toc-highlight">修代码优先还是改编译 flag 优先？</a></li><li><a href="#noqemu" class="table-of-contents__link toc-highlight">noqemu</a></li><li><a href="#rust" class="table-of-contents__link toc-highlight">Rust</a></li><li><a href="#sse-related-issue" class="table-of-contents__link toc-highlight">SSE Related issue</a></li><li><a href="#go" class="table-of-contents__link toc-highlight">Go</a><ul><li><a href="#patch-go-dep" class="table-of-contents__link toc-highlight">Patch <code>go dep</code></a></li><li><a href="#给-go-包的依赖的依赖打patch的正确方式" class="table-of-contents__link toc-highlight">给 go 包的依赖（的依赖）打patch的正确方式</a></li><li><a href="#编译-golang-包的时候经常卡死" class="table-of-contents__link toc-highlight">编译 golang 包的时候经常卡死</a></li><li><a href="#bad-pointer" class="table-of-contents__link toc-highlight">bad pointer</a></li></ul></li><li><a href="#版本号" class="table-of-contents__link toc-highlight">版本号</a></li><li><a href="#循环依赖" class="table-of-contents__link toc-highlight">循环依赖</a></li><li><a href="#intel-related" class="table-of-contents__link toc-highlight">Intel related</a></li><li><a href="#qmake" class="table-of-contents__link toc-highlight">Qmake</a></li><li><a href="#xx-is-not-available-for-the-riscv64-architecture" class="table-of-contents__link toc-highlight">XX is not available for the &#39;riscv64&#39; architecture</a></li><li><a href="#msse" class="table-of-contents__link toc-highlight">msse</a></li><li><a href="#unknown-public-key" class="table-of-contents__link toc-highlight">Unknown public key....</a></li><li><a href="#electron" class="table-of-contents__link toc-highlight">Electron</a></li><li><a href="#node-sass" class="table-of-contents__link toc-highlight">node-sass</a></li><li><a href="#关于-upstream" class="table-of-contents__link toc-highlight">关于 upstream</a></li><li><a href="#python-2to3" class="table-of-contents__link toc-highlight">Python 2to3</a></li><li><a href="#测试" class="table-of-contents__link toc-highlight">测试</a></li><li><a href="#访问一些会在编译期被删除的文件" class="table-of-contents__link toc-highlight">访问一些会在编译期被删除的文件</a></li><li><a href="#gcc-nostdlib" class="table-of-contents__link toc-highlight">gcc nostdlib</a></li><li><a href="#glibc-optimization" class="table-of-contents__link toc-highlight">glibc optimization</a></li><li><a href="#patch-hunk-offset" class="table-of-contents__link toc-highlight">patch hunk offset</a></li><li><a href="#unguarded-availability-new" class="table-of-contents__link toc-highlight">unguarded-availability-new</a></li><li><a href="#tarball-url-变了该怎么办" class="table-of-contents__link toc-highlight">tarball URL 变了该怎么办</a></li><li><a href="#在-qemu-内构建失败但在板子上构建成功怎么处理" class="table-of-contents__link toc-highlight">在 QEMU 内构建失败但在板子上构建成功怎么处理</a></li><li><a href="#invalid-or-corrupted-package-pgp-signature" class="table-of-contents__link toc-highlight">invalid or corrupted package (pgp signature)</a></li><li><a href="#磁盘占用满了" class="table-of-contents__link toc-highlight">磁盘占用满了</a></li><li><a href="#大量依赖缺失" class="table-of-contents__link toc-highlight">大量依赖缺失</a></li><li><a href="#configguess" class="table-of-contents__link toc-highlight">config.guess</a></li><li><a href="#nodejs-的某些包出现怪异的错误" class="table-of-contents__link toc-highlight">nodejs 的某些包出现怪异的错误</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Documents</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/felixonmars/archriscv-packages" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Avimitin, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.1e457bc7.js"></script>
<script src="/assets/js/main.42ec8c8f.js"></script>
</body>
</html>